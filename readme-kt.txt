
        TClock Light 改造版  by K.Takata
          Ver.kt1608xx (based on tclocklight-040702-3)

１．概要
　タスクトレイの時計を改造するソフトである TClock Light (かずぼん氏作)(*1) を
K.Takata が勝手に改変したものです。
　消費メモリの削減、ログ表示の改善、アラーム機能の強化、Vista/7/8/10 への対応、
x64 への対応などの変更を行っています。

(*1) http://homepage1.nifty.com/kazubon/tclocklight/


２．変更点
　オリジナルのバージョンである tclocklight-040702-3 からの変更点を
以下に示します。

2.1. 消費メモリの削減
　Win98 以降では、IME 関連の DLL を読み込まないように変更することで、
消費メモリを削減しました。(tclock.exe)
　リンカオプションで /WS:AGGRESSIVE を指定することにより、WinNT 系では、
自動的にワーキングセットサイズを削減するようになりました。(tclock.exe)

2.2. 右クリックメニューの挙動が不自然な点を修正
　右クリックメニューがキーボードで操作できなかったり、メニュー以外の領域を
クリックしてもメニューが消えないことがある問題を修正しました。

2.3. 右クリックメニューにアクセスキーを追加
　右クリックメニューにアクセスキーを追加することで、キーボードで素早く
項目を選択できるようにしました。

2.4. アラーム機能を強化
　レジューム時（スリープや休止状態からの復帰時）にプログラムを実行できる
ようにアラーム機能を強化しました。

　例えば、ノートパソコンなどで timeadjx(*2) を使う場合などに有用です。
（timeadjx を使うと時計の精度を向上させることができますが、休止状態などを
  使うと設定が初期化されてしまうため、復帰時に再実行する必要があります。）

(*2) http://www.monyo.com/technical/products/timeadjx/

2.5. 時刻合わせの設定画面でログを読み込むように変更
　時刻合わせの設定のダイアログボックスを表示する際に、ログ (SNTP.txt) の
最新 2KB を読み込んで表示するように変更しました。

2.6. 時刻合わせのログの表示欄を少し拡大
　ログの表示行数が 1行増えるはずです。

2.7. デフォルトの NTP サーバを変更
　デフォルトの NTP サーバを ntp1.jst.mfeed.ad.jp から、ラウンドロビンを
利用した ntp.jst.mfeed.ad.jp に変更しました。（サーバの負荷軽減のため）

2.8. XP テーマ変更時に時計の背景がおかしくなってしまうバグを修正
　TClock板 (*3) の「TClock Lightスレッド@別館 part1」の 17氏 の修正を
組み込みました。

(*3) http://tclock2ch.at.infoseek.co.jp/forum.html

2.9. Vista/7 で時計の文字の表示がおかしい問題を修正
　Vista で時計の文字の表示位置が上にずれたり、文字色がおかしい問題を
修正しました。
（Vista/7 では、WinXP と同じ処理で表示すればよいのだが、バージョン判定処理が
  間違っており、Win2k と同じ処理で表示していたのが原因。）

2.10. Vista/7 で管理者権限で起動するとメニューが表示されない問題を修正
　Vista/7 で tclock.exe を管理者権限で起動すると、UIPI (User Interface
Privilege Isolation) の制限で、時計を右クリックしてもメニューが
表示されなかった問題を修正しました。

2.11. Vista/7 のカレンダーに対応
　Vista/7 では、時計を左クリックするとカレンダーが表示されますが、この
カレンダーを TClock Light から表示することができるようになりました。
　「プロパティ」→「マウス操作」→「クリック」のシートを選択し、ボタンに
「左ボタン」「シングル」を選択し、機能に「TClockのコマンド」を選択し、
番号欄に「134」と入力すると、左クリックでカレンダーが表示されます。
　ダブルクリックにコマンドが登録されていると、シングルクリックかダブル
クリックかの判別が必要になるため、シングルクリックしてからカレンダーが
表示されるまでに、多少時間が掛かります。シングルクリックですぐにカレンダー
が表示されるようにするには、ダブルクリックにはコマンドを登録しないように
しておく必要があります。なお、Vista/7 では時計をダブルクリックしても
「日付と時刻のプロパティ」が表示されなくなりましたので、ダブルクリックの
コマンドは削除しておくと、Vista/7 標準と同じ操作になります。

2.12. 他の改造版の修正・機能拡張を取り込み
2.12.1. 修正の取り込み
　他の TClock Light 改造版によるバグ修正を一部取り込んでいます。詳細は更新履歴
を参照してください。

2.12.2. 機能拡張の取り込み
　以下の TClock Light 改造版の機能拡張をソースレベルで一部取り込んでいます。
それぞれの機能拡張はオフにしてありますので、使用する際には設定を変更して
コンパイルする必要があります。詳細は config-kt.txt を参照してください。

・tclocklight-050716
・TClock Light Unofficial 060502
・tclocklight- 080409

　ツールチップの拡張や、アナログ時計、影、縁取りは取り込んでいません。

2.13. x64 への対応
　x64 に正式対応しました。
　x64 ディレクトリに入っているファイルが x64 用の実行ファイルです。使う際
には、x64 用実行ファイルを置いたディレクトリの下に lang ディレクトリを
コピーしてください。

　TClock Light を起動した際に、"language file not found" と表示される場合や、
時計を右クリックした際に、メニューに Exit TClock としか表示されない場合は、
インストールに失敗しています。以下のようなディレクトリ構成になっていることを
再度確認してください。

     tclock
     │  tcdll.tclock
     │  tclock.exe
     │  tcplayer.exe
     │  tcprop.exe
     │  tcsntp.exe
     │  tctimer.exe
     │
     └─lang
             tclang-ja.txt
             tclang.txt
             tcmenu-ja.txt
             tcmenu.txt

　なお、x64 への対応は tclocklight-040702-3-amd64 (*4) を参考にしています。

(*4)
 http://www.program-lab.jp/blog/progmemo/archives/2005/05/tclock_lightox6.html

　実際には、上記サイトの通りに SetWindowLong() を SetWindowLongPtr() に
書き換えるのではなく、windowsx.h で定義されている SubclassWindow() などの
マクロに書き換えています。また、それ以外の変更についてもそのまま適用すると
素の VC6 でコンパイルできなくなってしまうため、そのための対策をしてあります。


３．判明している Vista/7 上での問題点
3.1. 管理者権限で起動しないと、tcsntp.exe による時刻合わせができない
　Vista/7 では、時刻を設定するには管理者権限が必要です。そのため、
UAC (User Account Control) が有効な場合に、tcsntp.exe を使って SNTP で
時刻合わせをしたい場合は、tclock.exe を管理者権限で起動しなければ
いけません。しかしこれを行うと、TClock Light から起動される他のプログラムも
管理者権限で起動されることとなり、セキュリティー上の危険性が高くなるので
お薦めしません。

3.2. スタートアップで tclock.exe を管理者権限で起動できない
　UAC が有効な場合、スタートアップで tclock.exe を管理者権限で起動しようと
しても、ブロックされてしまいます。管理者権限で起動するためには、毎回手動で
ブロックを解除する必要があります。
（スタートアップの代わりにタスクスケジューラを使えば、ブロックは回避でき
ますが、前述のようにセキュリティー上の観点からお薦めしません。なお、タスク
スケジューラを使う場合は、Explorer の起動後に TClock Light が起動するよう
に設定する必要があります。）

※以上のような問題があるため、Vista/7 での時刻合わせは、TClock Light の機能を
  使わずに、OS の標準機能を使うことをお薦めします。設定の詳細は、例えば以下の
  サイトを参照してください。
  http://wiki.nothing.sh/page?NTP
  http://www.daytradenet.com/blog/tokidoki/archives/12/11/041530.html

※他の方法としては、タスクスケジューラから tcsntp.exe を定期的に起動する
  ようにし、tclock.exe は通常権限のまま起動する方法もあります。

3.3. スタートボタンの改造が機能しない
　スタートボタンを改造する、時計にスタートメニューの各機能が動作しません。
現時点では修正の見通しは立っていません。

3.4. C:\Program Files 以下にインストールすると時計が改造できない
　UAC が有効な場合、C:\Program Files 以下のファイルを変更するには管理者権限が
必要です。TClock Light を C:\Program Files 以下にインストールすると、設定
ファイル (tclock.ini) を正しく読み書きできなくなるため、時計が改造できない
などの問題が発生します。
　回避方法としては、TClock Light は一般権限で書き込めるフォルダにインストール
するようにしてください。
　どうしても C:\Program Files 以下にインストールしたい場合は、tclock.ini を
一般ユーザーが書き込みできるように、アクセス許可を変更してください。


４．更新履歴
2005/04/07
・メモリ消費量削減。

2005/04/09
・右クリックメニューの挙動改善。
・右クリックメニューにアクセスキー追加。

2005/04/26
・アラーム機能強化。

2005/04/29
・ログ表示改善。（SNTP.txt の末尾 2KB を読み込んで表示。）
・デフォルト NTP サーバ変更。

2005/05/07
・メニューの順番を修正。

2005/05/12
・ログ表示改善。（行単位で表示。）

2006/01/04
・時刻合わせ精度向上版を組み込む。
・ログ表示改善。（tclocklight-050716 を参考に修正）
　ゴミを表示しないように修正。
　ダイアログを開いたときにログの最終行を表示するように改善。

2007/03/21
・ログ表示改善。
　ログファイルサイズが 2KB に満たないときは、ファイルの先頭から表示するよう
  に修正。（今までは、行単位で表示されるようにするために、最初の改行までは
  必ず読み飛ばしていた。そのため先頭行が表示されなかった。）
・メモリ消費量削減機能の修正。
　DisableIME() で FreeLibrary() が実行されない可能性があったのを修正。
・XP でテーマ変更時の動作の修正。
・時刻合わせ精度向上版の組み込みをやめた。
　（実行エラーが発生することがあったため。）

2007/12/23
・Vista のカレンダー表示に対応。（コマンド番号 134 を使用）
・リンカオプションで /WS:AGGRESSIVE を指定することで、メモリ使用量を削減。
  (tclock.exe のみ)
・tclocklight-040702-3-amd64 を参考に、X64 用にコンパイルできるように修正。
  動作は未確認。
  (新しい PSDK を入れていない VC6 でもコンパイルできるように対策済み。)
・tclocklight-050716 の修正をいくつか取り込む。
  - アラームの書式でうっかり0時間おきや0分おきにすると無限ループになるのを修正
  - WinXP以外で背景色1のチェックを外すと表示がおかしくなるのを修正
  - 書式Yの値が10の累乗の時、1桁表示されないのを修正
  - TransparentBlt()をWin98では使わないように修正（リソースリークするらしい）
  - 数字を入力するべきエディットボックスは数字以外入力できないように修正
  - アラームの曜日の設定の表示を修正

2007/12/29
・X64 対応修正その２。DialogProc の戻り値を BOOL から INT_PTR に修正。
  動作は未確認。

2009/06/27
・Vista でメイリオなどを使ったときに文字がにじむのを修正。
・Vista でデフォルトフォントとしてメイリオを取得できるように修正。
・x64 対応の修正漏れがあったため修正。(sntp.c L53 / int → SOCKET)
・x64 に正式に対応。
・DLL のベースアドレスを設定。（0x66040000 または 0x60066040000）
・コンパイル方法に関する修正
  - x64 コンパイル時の作業/出力ディレクトリを、x86 とは別にした。
  - x64 コンパイル時も NODEFAULTLIB でファイルサイズを小さくできるようにした。
  - VC2005 以降を使ったときに出る、セキュリティが弱い関数に対する警告を
    抑制した。（_CRT_SECURE_NO_WARNINGS）

2009/06/28
・Vista Aero 不使用時の文字描画方式を以前のものに戻した。
　（低スペックマシンで文字がちらつく場合があったため。）

2009/07/04
・tclocklight-050716 の修正をいくつか取り込む。
  - WinXP SP2でモニターOFFが使えないかもしれないのを修正したかも
・他の改造版による機能拡張をソースレベルで組み込み。
　config.h を修正してコンパイルすることで、各機能を個別に有効化/無効化できる
　ようにした。
・機能の有効化/無効化対応の都合上、プロパティ画面のページ順序を一部入れ替え。

2009/07/08
・XP などで文字色の初期値が正しく設定されない場合があったのを修正。
・Vista でも音量関連機能が使えるように修正。
・x64 でメモリ関連の書式が動かなかったのを修正。
・メモリ使用率の計算がバグっていたのを修正。
・メモリ関連の書式で小数部を扱えるように変更。
・メモリ関連の書式に GB 単位の書式を追加。

2009/07/12
・DWM 使用有無のチェックを簡略化。
・format-kt.txt 追加。
・XP でタスクバーボタンをグループ化しないようにした場合、「タスクバーに
  アイコンのみを表示」設定を有効にできるように変更。
・Win2k 以降では、メッセージ専用ウィンドウを使うことで、メモリ消費量削減。
・Vista でスタートボタンを隠せるように変更。

2009/07/18
・http://distantland.hp.infoseek.co.jp/tclock/mod/ で公開されていた
 「TClock Light 時刻合わせ精度向上版」および tclocklight-050716 の
  tcsntp 関連の修正をマージ、さらに独自に精度向上。
  - Distantland 版では RFC 1769（最新は RFC 4330）に従って、パケットの往復
    時間を考慮して時刻合わせをするように修正。
  - 050716 版では Distantland 版 を Borland C++ でコンパイルできるようにする
    ため、インラインアセンブラ部分を C に修正。（修正の過程で、0.1% 程度の
    計算誤差が含まれていた模様。）
  - いずれの版も GetSystemTimeAsFileTime() の精度については全く考慮して
    いなかったため、考慮するように修正。
   （GetSystemTimeAsFileTime() は、XP 以前では、たいていの場合 15ms 程度の
    分解能しかないため、tcsntp を使って時刻合わせをした直後に、再度 tcsntp を
    実行しても 15ms 程度のずれが出る場合があった。なお、Vista 以降では分解能は
    1ms に向上している模様。）
・権限がない状態で、tcsntp を使って時刻合わせをしようとした場合に、ログに
  エラーの原因を残すように修正。

2009/07/19
・メッセージ専用ウィンドウを使うと、「レジューム時に実行」が機能しなくなる
  （＝WM_POWERBROADCAST を受け取れなくなる）ことが判明したため、元に戻した。
・Vista で C:\Program Files 以下にインストールした場合の制限事項を追記。

2009/07/23
・デスクトップアイコンに関する機能を有効化したときに、更新間隔に合わせて
  デスクトップアイコンがちらついていたのを修正。

2009/07/27
・XP で「タスクバーにアイコンのみを表示」設定を使えるようにする条件を間違えて
  いたのを修正。（タスクバーボタンのグループ化ではなく、「タスクバーボタンを
  スライドする」を off にしたときに使えるように修正。）
・Vista で Aero と互換のないソフトを使うことで、一時的に Aero がオフになった
  場合に、文字がちらつくのを修正。

2009/07/29
・時刻合わせの設定画面を表示中に tcsntp /silent を実行した場合でも、時刻
  合わせが行われるように変更。
・Vista では、時刻合わせの設定画面の「今すぐ同期」ボタンにシールドアイコンが
  表示されるように変更。（ボタンを押すと、昇格ダイアログが表示され、許可した
  場合には時刻合わせが行われる。）
・x64 で CPU 使用率の拡張書式が使えなかったのを修正。

2009/08/22
・時計ウィンドウにフォーカスがあるときに、アプリケーションキーを押して
  メニューを出すと、変な位置に表示されるのを修正。
・隠しウィンドウのウィンドウスタイルを WS_DISABLED に変更。（環境によっては
  さらなる省メモリ化。）

2009/09/06
・Vista でネットワーク送受信量の拡張書式を使うと、実際の転送量よりも大きい
  数値が表示されるのを修正。
・ネットワーク送受信量に、無線 LAN の送受信量を含めるように修正。

2009/09/23
・tclocklight-unofficial-060502 の変更を一部取り込む。
  - キュ！機能を少し変更。タスクバーがどの位置にあっても、タスクバーに
    重なった窓を押し戻す機能に。
・ウィンドウ移動に使う API を SetWindowPos() に統一。

2009/09/26
・Vista で C:\Program Files 以下にインストールした場合など、tclock.ini に
  設定を書き込めなかった場合に、エラーメッセージを表示するように修正。
  （ただし今回は、tclock.exe のみの対応。）

2010/02/04
・tclocklight-050716 の修正を一部取り込む。
  - フォントサイズを3の倍数でない数にすると本来より小さく表示されるのを修正
・Windows 7 での動作を確認。
・Vista/7 でカレンダーが表示された状態で、再度時計を左クリックすると、一度
  カレンダーが消えてから再度表示されるのを修正。

2012/01/04
・Vista/7 で、音量の書式を使った際に、実際より 1 小さい値が表示される場合が
  あるのを修正。
・日付が変わる際、毎秒表示更新を行うフラグを off にしていたのを修正。
・x64 版のインストール方法の詳細を追記。
・NTP の設定方法の記載を、wiki@nothing の記事を参照するように変更。
・Windows SDK 7.1 による x64 ビルドに対応。
・tclock.exe 起動時に lang ディレクトリが見つからない場合はメッセージを
  表示するように変更。
・SNTP のログに年の表示を追加。

2016/08/xx
・Windows 10 Anniversary Update で動かない問題の暫定対処。
・High DPI 暫定対応。
・Win9x/NT4/2000 サポート終了。古いコードの削除。


５．ライセンス
　オリジナルのライセンスが GPL であるため、この改造版のライセンスも
当然 GPL です。


６．連絡先
  改造版作者: K.Takata
  URL: http://k-takata.o.oo7.jp/
       https://github.com/k-takata/TClockLight (ソースコード)

